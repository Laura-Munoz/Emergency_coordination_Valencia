# streamlit_app.py
import streamlit as st
import time
from datetime import datetime
from admin_view import admin_page
from coordinator_view import coordinator_page
from volunteer_view import volunteer_page
from database import EmergencyDatabase
from config import CENTER_LAT, CENTER_LON, INITIAL_ZONES

# Limpiar cache al inicio
st.cache_data.clear()
st.cache_resource.clear()

# Configuraci√≥n optimizada para Streamlit Cloud
st.set_page_config(
   page_title="Sistema de Emergencias Valencia",
   page_icon="üö®",
   layout="centered",  # Cambiar a centered para mejor rendimiento m√≥vil
   initial_sidebar_state="collapsed",
   menu_items={
       'Get Help': None,
       'Report a bug': None,
       'About': None
   }
)

# Optimizaciones para m√≥vil
st.markdown("""
   <style>
   /* Optimizaciones generales */
   .stApp {
       max-width: 100%;
       padding: 1rem;
   }
   
   /* Optimizaciones m√≥viles */
   @media (max-width: 768px) {
       .stApp {
           padding: 0.5rem;
       }
       
       .stButton > button {
           width: 100%;
           margin: 0.2rem 0;
       }
       
       .stMarkdown {
           font-size: 0.9rem;
       }
       
       /* Ajustar sidebar */
       .css-1d391kg {
           padding: 1rem 0.5rem;
       }

       /* Optimizar footer en m√≥vil */
       .footer {
           font-size: 10px;
           padding: 3px;
       }
   }
   </style>
""", unsafe_allow_html=True)

# Funci√≥n para verificar credenciales de admin
def verify_admin(username, password, secret_key):
   return (username == "admin" and 
           password == "admin_password" and
           secret_key == ADMIN_SECRET_KEY)

def main():
   try:
       with st.spinner("Cargando..."):
           # Timeout de 10 segundos para carga inicial
           start_time = time.time()
           
           # Inicializar la base de datos con timeout
           try:
               db = EmergencyDatabase()
               st.success("Conectado exitosamente")
           except Exception as e:
               if time.time() - start_time >= 10:
                   st.error("Tiempo de conexi√≥n excedido. Por favor, recarga la p√°gina.")
                   st.stop()
               st.error(f"Error en la conexi√≥n: {str(e)}")
               st.stop()
           
           # Inicializar el estado de la sesi√≥n si es necesario
           if 'authenticated' not in st.session_state:
               st.session_state.authenticated = False
               st.session_state.role = None

           # A√±adir una clave secreta para acceso admin
           global ADMIN_SECRET_KEY
           ADMIN_SECRET_KEY = "admin123"

           # Sidebar para gesti√≥n de roles y autenticaci√≥n
           with st.sidebar:
               st.title("üîê Acceso al Sistema")
               
               if not st.session_state.authenticated:
                   # Bot√≥n oculto para acceso admin
                   if st.session_state.get('show_admin', False):
                       if st.button("‚Üê Volver", key='back_button'):
                           st.session_state.show_admin = False
                           st.rerun()
                       
                       st.write("üîí Acceso Administrativo")
                       with st.form("admin_login"):
                           admin_user = st.text_input("Usuario")
                           admin_pass = st.text_input("Contrase√±a", type="password")
                           admin_key = st.text_input("Clave de Seguridad", type="password")
                           if st.form_submit_button("Ingresar"):
                               if verify_admin(admin_user, admin_pass, admin_key):
                                   st.session_state.authenticated = True
                                   st.session_state.role = "Administrador"
                                   st.rerun()
                               else:
                                   st.error("Credenciales incorrectas")
                   
                   else:
                       # Selector normal para usuarios regulares
                       role_selection = st.radio(
                           "Seleccionar Rol",
                           ["Voluntario", "Coordinador"]
                       )
                       
                       # Bot√≥n oculto para mostrar acceso admin
                       col1, col2, col3 = st.columns([1,1,1])
                       with col3:
                           if st.button("‚öôÔ∏è", key="admin_access"):
                               st.session_state.show_admin = True
                               st.rerun()
                       
                       if role_selection == "Voluntario":
                           if st.button("Acceder como Voluntario"):
                               st.session_state.authenticated = True
                               st.session_state.role = "Voluntario"
                               st.rerun()
                               
                       elif role_selection == "Coordinador":
                           st.write("Ingreso como Coordinador")
                           username = st.text_input("Usuario", key="coord_user")
                           password = st.text_input("Contrase√±a", type="password", key="coord_pass")
                           if st.button("Ingresar", key="coord_submit"):
                               try:
                                   success, result = db.verify_coordinator(username, password)
                                   if success:
                                       st.session_state.authenticated = True
                                       st.session_state.role = role_selection
                                       st.session_state.user_info = result
                                       st.rerun()
                                   else:
                                       st.error(result)
                               except Exception as e:
                                   st.error(f"Error en la verificaci√≥n: {str(e)}")
               
               else:
                   st.success(f"Rol actual: {st.session_state.role}")
                   if st.button("Cerrar Sesi√≥n"):
                       for key in list(st.session_state.keys()):
                           del st.session_state[key]
                       st.rerun()

           # Mostrar la vista correspondiente seg√∫n el rol
           if st.session_state.authenticated:
               if st.session_state.role == "Administrador":
                   admin_page()
               elif st.session_state.role == "Coordinador":
                   coordinator_page()
               elif st.session_state.role == "Voluntario":
                   volunteer_page()
           else:
               # P√°gina de bienvenida
               st.title("üö® Sistema de Emergencias Valencia")
               st.write("### Bienvenido al Sistema de Coordinaci√≥n de Emergencias")
               st.info("""
                   üëà Por favor, selecciona tu rol en el panel izquierdo para comenzar:
                   
                   - ü§ù **Voluntario**: Acceso directo al mapa de zonas
                   - üë• **Coordinador**: Requiere autenticaci√≥n
                   - üîß **Administrador**: Requiere autenticaci√≥n
               """)

   except Exception as e:
       st.error(f"Error en la aplicaci√≥n: {str(e)}")
       st.stop()

if __name__ == "__main__":
   main()

# Footer optimizado
st.markdown("""
   <div class="footer" style="position: fixed; bottom: 0; left: 0; width: 100%; 
        background-color: rgba(0,0,0,0.8); padding: 5px; text-align: center; color: white;">
       Developed by Laura M. Mu√±oz Amaya | üìß lm.munozamaya7@gmail.com | ¬© 2024
   </div>
""", unsafe_allow_html=True)

